<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upload Document | MetaVault</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bg-light': '#FEFCF5',
            'bg-dark': '#F4F1E8',
            'text-primary': '#111111',
            'accent': '#FF5500',
            'card-bg': '#1A1A1A',
          },
          fontFamily: {
            'main': ['Geist', 'Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
</head>

<body class="bg-bg-light text-text-primary min-h-screen">

  <!-- AUTH GUARD -->
  <script>
    if (!localStorage.getItem("auth_method")) {
      window.location.href = "login.html";
    }
  </script>

  <!-- HEADER -->
  <header class="w-full px-10 py-8">
    <div class="max-w-[1440px] mx-auto flex justify-between items-center">
      <a href="index.html" class="text-3xl font-medium">MetaVault</a>
      <nav class="flex gap-8 text-sm">
        <a href="dashboard.html" class="hover:text-accent">Dashboard</a>
        <a href="upload.html" class="text-accent">Upload</a>
        <a href="login.html" class="hover:text-accent">Logout</a>
      </nav>

    </div>
  </header>

  <!-- MAIN -->
  <main class="w-full px-10 py-16">
    <div class="max-w-[1440px] mx-auto max-w-4xl">

      <h1 class="text-[4rem] font-normal mb-8">Upload Document</h1>
      <div class="mb-10">
        <a href="dashboard.html"
          class="inline-flex items-center gap-2 text-sm font-medium hover:text-accent transition">
          ‚Üê Back to Dashboard
        </a>
      </div>


      <!-- UPLOAD AREA -->
      <div id="uploadArea"
        class="border-2 border-dashed border-gray-300 rounded-2xl p-16 text-center cursor-pointer mb-4">
        <input type="file" id="kycFile" hidden />
        <p id="fileLabel" class="text-lg font-medium mb-2">
          Drag and drop your file here
        </p>
        <p class="text-sm text-gray-500">or click to browse</p>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="flex gap-4">
        <button id="uploadBtn"
          class="flex-1 bg-accent text-white px-8 py-4 rounded-full font-medium text-lg hover:opacity-90">
          Upload and Verify
        </button>

        <button id="cancelBtn"
          class="px-8 py-4 rounded-full border border-gray-300 font-medium text-lg">
          Cancel
        </button>
      </div>

      <p id="status" class="mt-6 text-sm whitespace-pre-line"></p>

    </div>
  </main>

  <!-- UPDATED LOGIC -->
  <script type="module">
    const uploadBtn = document.getElementById("uploadBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const fileInput = document.getElementById("kycFile");
    const uploadArea = document.getElementById("uploadArea");
    const statusEl = document.getElementById("status");
    const fileLabel = document.getElementById("fileLabel");

    const PINATA_JWT = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiJmMjk0NGU2YS0xYjQ4LTQ4ZjQtYTQwNi01MWNlMTdiMDcwZDEiLCJlbWFpbCI6Im1hY2MuYW5kcm9zc0BnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwicGluX3BvbGljeSI6eyJyZWdpb25zIjpbeyJkZXNpcmVkUmVwbGljYXRpb25Db3VudCI6MSwiaWQiOiJGUkExIn0seyJkZXNpcmVkUmVwbGljYXRpb25Db3VudCI6MSwiaWQiOiJOWUMxIn1dLCJ2ZXJzaW9uIjoxfSwibWZhX2VuYWJsZWQiOmZhbHNlLCJzdGF0dXMiOiJBQ1RJVkUifSwiYXV0aGVudGljYXRpb25UeXBlIjoic2NvcGVkS2V5Iiwic2NvcGVkS2V5S2V5IjoiYjE2ODhjZTk0Zjc3MzhkYzRmMGIiLCJzY29wZWRLZXlTZWNyZXQiOiIxNzY4N2FiYWExNDgzMGU0NTY1MWMyMjQzMDdkZDA3ZjI2OWRmOGFmMjc5ZjRhMzNmZDQ1MTlkZDMyZDUzZTAxIiwiZXhwIjoxNzk1MDIyMjkwfQ._3ALI7Bh5GDTRWEo_xBBU0Q13uX3cd5FwdBYta3iEOk";
    const BACKEND_URL = "https://metavault-backend.onrender.com/store-kyc";

    let abortController = null;

    uploadArea.addEventListener("click", () => fileInput.click());

    uploadArea.addEventListener("dragover", e => {
      e.preventDefault();
      uploadArea.classList.add("bg-gray-100");
    });

    uploadArea.addEventListener("dragleave", () => {
      uploadArea.classList.remove("bg-gray-100");
    });

    uploadArea.addEventListener("drop", e => {
      e.preventDefault();
      uploadArea.classList.remove("bg-gray-100");
      fileInput.files = e.dataTransfer.files;
      showSelectedFile();
    });

    fileInput.addEventListener("change", showSelectedFile);

    function showSelectedFile() {
      const file = fileInput.files[0];
      if (file) {
        fileLabel.textContent = `Selected file: ${file.name}`;
      }
    }

    cancelBtn.addEventListener("click", () => {
      if (abortController) {
        abortController.abort();
        abortController = null;
      }
      statusEl.innerText = "Upload cancelled.";
    });

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) return alert("Select a file first.");

      abortController = new AbortController();

      try {
        statusEl.innerText = "Uploading to IPFS";

        const formData = new FormData();
        formData.append("file", file);

        const res = await fetch(
          "https://api.pinata.cloud/pinning/pinFileToIPFS",
          {
            method: "POST",
            headers: {
              Authorization: `Bearer ${PINATA_JWT}`
            },
            body: formData,
            signal: abortController.signal
          }
        );

        const data = await res.json();
        const CID = data.IpfsHash;

        statusEl.innerText =
          `Uploaded to IPFS\nCID: ${CID}\nSubmitting transaction`;

        const backendRes = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cid: CID }),
          signal: abortController.signal
        });

        const backendJson = await backendRes.json();

        if (!backendJson.ok) throw new Error("Backend failed");

        statusEl.innerHTML =
          `Stored on-chain\n<a class="text-accent underline" target="_blank"
           href="https://sepolia.etherscan.io/tx/${backendJson.txHash}">
           View on Etherscan</a>`;

        const history = JSON.parse(localStorage.getItem("tx_history") || "[]");
        history.unshift({
          cid: CID,
          txHash: backendJson.txHash,
          time: new Date().toISOString()
        });

        localStorage.setItem("tx_history", JSON.stringify(history));

      } catch (err) {
        if (err.name === "AbortError") {
          statusEl.innerText = "Upload cancelled.";
        } else {
          console.error(err);
          statusEl.innerText = "Upload failed.";
        }
      }
    });
  </script>

</body>
</html>
